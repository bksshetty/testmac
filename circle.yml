machine:
  xcode:
    version: "6.4"
dependencies:
  pre:
    - sudo brew install wget
    - curl -O https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz
    - sudo gem install rubygems-update
    - sudo update_rubygems
    - sudo gem install rhc
    - sudo gem install shenzhen
    - sudo gem install highline --version 1.7.2
    - sudo pip install Appium-Python-Client
    - sudo pip install pytest
test:
  override:
    - cd sc-*-linux && ./bin/sc --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY --readyfile ~/sauce_is_ready:
        background: true
    # Wait for tunnel to be ready
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    - python -m hello.hello_app:
        background: true
    # Wait for app to be ready
    - curl --retry 10 --retry-delay 2 -v http://localhost:5000
    # Run selenium tests
    - nosetests
    - ./scripts/add-key.sh
    - ipa build -c Distribution
    - xctool
      -reporter pretty
      -reporter junit:$CIRCLE_TEST_REPORTS/xcode/results.xml
      -reporter plain:$CIRCLE_ARTIFACTS/xctool.log
      CODE_SIGNING_REQUIRED=YES
      CODE_SIGN_IDENTITY="security import ./scripts/dist.p12 -k ~/Library/Keychains/ios-build.keychain -P $KEY_PASSWORD -T /usr/bin/codesign"
      PROVISIONING_PROFILE="security import ./scripts/dist.cer -k ~/Library/Keychains/ios-build.keychain -T /usr/bin/codesign"
      -sdk iphonesimulator
      -scheme "ClarksCollection"
      build
deployment:
  hockey:
    branch: master
    commands:
      - ipa distribute:crashlytics -c Crashlytics.framework -a $API_KEY -s $BUILD_SECRET